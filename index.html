<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>QR Scanner</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="text-align:center; font-family:Arial; padding:20px;">
<h2>üì∑ –°–∫–∞–Ω—É–≤–∞–Ω–Ω—è QR</h2>
<button id="scanBtn">‚ñ∂Ô∏è –ü–æ—á–∞—Ç–∏ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è</button>
<div id="reader" style="margin-top:20px;"></div>
<p id="result">–û—á—ñ–∫—É—é —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è...</p>

<script>
let html5QrCode;

document.getElementById("scanBtn").addEventListener("click", async () => {
    html5QrCode = new Html5Qrcode("reader");

    try {
        const cameras = await Html5Qrcode.getCameras();
        if (!cameras || cameras.length === 0) {
            alert("–ö–∞–º–µ—Ä–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ");
            return;
        }

        // üî¥ –í–∏–±—ñ—Ä –∑–∞–¥–Ω—å–æ—ó –∫–∞–º–µ—Ä–∏
        const backCamera = cameras.find(cam =>
            cam.label.toLowerCase().includes("back") ||
            cam.label.toLowerCase().includes("rear")
        );
        const cameraId = backCamera ? backCamera.id : cameras[cameras.length - 1].id;

        html5QrCode.start(
            cameraId,
            { fps: 10, qrbox: 250 },
            decodedText => {
                document.getElementById("result").innerText = "‚úÖ –í—ñ–¥—Å–∫–∞–Ω–æ–≤–∞–Ω–æ: " + decodedText;

                html5QrCode.stop().then(async () => {
                    if (window.Telegram && Telegram.WebApp) {

                        // üõ∞ –û—Ç—Ä–∏–º—É—î–º–æ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é (—è–∫—â–æ –¥–æ–∑–≤–æ–ª–µ–Ω–æ)
                        let location = null;
                        try {
                            location = await Telegram.WebApp.getUserLocation();
                        } catch(e){}

                        const payload = {
                            qr: decodedText,
                            lat: location ? location.latitude : null,
                            lon: location ? location.longitude : null
                        };

                        Telegram.WebApp.sendData(JSON.stringify(payload));
                        Telegram.WebApp.close();
                    } else {
                        alert("–í—ñ–¥–∫—Ä–∏–π—Ç–µ —Ü—é —Å—Ç–æ—Ä—ñ–Ω–∫—É —á–µ—Ä–µ–∑ Telegram");
                    }
                });
            },
            errorMessage => { /* —ñ–≥–Ω–æ—Ä—É—î–º–æ –ø–æ–º–∏–ª–∫–∏ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è */ }
        );

    } catch (e) {
        alert("–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏: " + e);
    }
});
</script>
</body>
</html>
